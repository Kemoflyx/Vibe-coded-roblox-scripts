local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local hrp = character:WaitForChild("HumanoidRootPart")

local LOCK_KEY = Enum.KeyCode.E
local lockedTarget = nil
local isLocked = false
local targetHighlight = nil


local targetCache = {} -- [HumanoidRootPart] = true

local function applyHighlight(target)
    if targetHighlight then targetHighlight:Destroy() end
    local h = Instance.new("Highlight")
    h.Adornee = target.Parent
    h.FillTransparency = 1
    h.OutlineTransparency = 0
    h.OutlineColor = Color3.fromRGB(255, 255, 255)
    h.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    h.Parent = target.Parent
    targetHighlight = h
end

local function removeHighlight()
    if targetHighlight then
        targetHighlight:Destroy()
        targetHighlight = nil
    end
end


local function addToCache(root, hum)
    if root and hum and hum.Health > 0 then
        targetCache[root] = true
    end
end

local function removeFromCache(root)
    targetCache[root] = nil
end

local function isValidTarget(char)
    return char and char ~= character and char:FindFirstChild("Humanoid") and char:FindFirstChild("HumanoidRootPart")
end


for _, p in ipairs(Players:GetPlayers()) do
    if p ~= player and p.Character then
        local char = p.Character
        if isValidTarget(char) then
            addToCache(char.HumanoidRootPart, char.Humanoid)
        end
    end
end


for _, obj in ipairs(workspace:GetDescendants()) do
    if obj:IsA("Model") and isValidTarget(obj) then
        addToCache(obj.HumanoidRootPart, obj.Humanoid)
    end
end


Players.PlayerAdded:Connect(function(p)
    p.CharacterAdded:Connect(function(char)
        task.wait(0.5)
        if isValidTarget(char) then
            addToCache(char.HumanoidRootPart, char.Humanoid)
        end
    end)
end)


for _, p in ipairs(Players:GetPlayers()) do
    if p ~= player then
        p.CharacterAdded:Connect(function(char)
            task.wait(0.5)
            if isValidTarget(char) then
                addToCache(char.HumanoidRootPart, char.Humanoid)
            end
        end)
    end
end


workspace.DescendantAdded:Connect(function(obj)
    if obj:IsA("Model") then
        task.wait(0.1)
        if isValidTarget(obj) then
            addToCache(obj.HumanoidRootPart, obj.Humanoid)
        end
    end
end)


workspace.DescendantRemoving:Connect(function(obj)
    if obj:IsA("HumanoidRootPart") then
        removeFromCache(obj)
    end
end)

Players.PlayerRemoving:Connect(function(p)
    if p.Character then
        local root = p.Character:FindFirstChild("HumanoidRootPart")
        if root then
            removeFromCache(root)
        end
    end
end)


local function findClosest()
    local mouse = UserInputService:GetMouseLocation()
    local cam = workspace.CurrentCamera
    local closest, bestDist = nil, math.huge
    

    for root, _ in pairs(targetCache) do
        if root.Parent then
            local hum = root.Parent:FindFirstChild("Humanoid")
            if hum and hum.Health > 0 then
                local pos, onScreen = cam:WorldToViewportPoint(root.Position)
                if onScreen then
                    local dist = (Vector2.new(pos.X, pos.Y) - mouse).Magnitude
                    if dist < bestDist then
                        bestDist = dist
                        closest = root
                    end
                end
            else
                removeFromCache(root)
            end
        else
            removeFromCache(root)
        end
    end
    
    return closest
end


local function lockRotation()
    if not lockedTarget or not lockedTarget.Parent then return end
    
    local targetPos = lockedTarget.Position
    local myPos = hrp.Position
    
    -- Direction (horizontal only)
    local dir = Vector3.new(targetPos.X - myPos.X, 0, targetPos.Z - myPos.Z)
    
    if dir.Magnitude > 0.01 then

        local lookCFrame = CFrame.lookAt(myPos, myPos + dir)
        hrp.CFrame = CFrame.new(myPos) * (lookCFrame - lookCFrame.Position)
    end
end


local function toggle()
    if isLocked then
        isLocked = false
        lockedTarget = nil
        humanoid.AutoRotate = true
        removeHighlight()
    else
        local target = findClosest()
        if target then
            isLocked = true
            lockedTarget = target
            humanoid.AutoRotate = false
            applyHighlight(target)
        end
    end
end

UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if not gameProcessed and input.KeyCode == LOCK_KEY then
        toggle()
    end
end)


RunService.RenderStepped:Connect(function()
    if isLocked then

        humanoid.AutoRotate = false
        

        if not lockedTarget or not lockedTarget.Parent then
            toggle()
            return
        end
        
        local hum = lockedTarget.Parent:FindFirstChild("Humanoid")
        if not hum or hum.Health <= 0 then
            toggle()
            return
        end
        

        lockRotation()
    end
end)

player.CharacterAdded:Connect(function(char)
    character = char
    humanoid = char:WaitForChild("Humanoid")
    hrp = char:WaitForChild("HumanoidRootPart")
    isLocked = false
    lockedTarget = nil
    removeHighlight()
end)
