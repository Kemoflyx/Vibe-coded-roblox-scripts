
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local hrp = character:WaitForChild("HumanoidRootPart")

local LOCK_KEY = Enum.KeyCode.E
local lockedTarget = nil
local isLocked = false
local targetHighlight = nil

-- ===== HIGHLIGHT =====
local function applyHighlight(target)
    if targetHighlight then targetHighlight:Destroy() end
    local h = Instance.new("Highlight")
    h.Adornee = target.Parent
    h.FillTransparency = 1
    h.OutlineTransparency = 0
    h.OutlineColor = Color3.fromRGB(255, 255, 255)
    h.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    h.Parent = target.Parent
    targetHighlight = h
end

local function removeHighlight()
    if targetHighlight then
        targetHighlight:Destroy()
        targetHighlight = nil
    end
end

-- ===== FIND CLOSEST TARGET =====
local function findClosest()
    local mouse = UserInputService:GetMouseLocation()
    local cam = workspace.CurrentCamera
    local closest, bestDist = nil, math.huge
    
    for _, p in ipairs(Players:GetPlayers()) do
        if p ~= player and p.Character then
            local root = p.Character:FindFirstChild("HumanoidRootPart")
            local hum = p.Character:FindFirstChild("Humanoid")
            if root and hum and hum.Health > 0 then
                local pos, onScreen = cam:WorldToViewportPoint(root.Position)
                if onScreen then
                    local dist = (Vector2.new(pos.X, pos.Y) - mouse).Magnitude
                    if dist < bestDist then
                        bestDist = dist
                        closest = root
                    end
                end
            end
        end
    end
    return closest
end

-- ===== RAW ROTATION - NO BULLSHIT =====
local function lockRotation()
    if not lockedTarget or not lockedTarget.Parent then return end
    
    local targetPos = lockedTarget.Position
    local myPos = hrp.Position
    
    -- Direction (horizontal only)
    local dir = Vector3.new(targetPos.X - myPos.X, 0, targetPos.Z - myPos.Z)
    
    if dir.Magnitude > 0.01 then
        -- INSTANT SNAP - OVERWRITE EVERYTHING
        local lookCFrame = CFrame.lookAt(myPos, myPos + dir)
        hrp.CFrame = CFrame.new(myPos) * (lookCFrame - lookCFrame.Position)
    end
end

-- ===== TOGGLE =====
local function toggle()
    if isLocked then
        isLocked = false
        lockedTarget = nil
        humanoid.AutoRotate = true
        removeHighlight()
    else
        local target = findClosest()
        if target then
            isLocked = true
            lockedTarget = target
            humanoid.AutoRotate = false
            applyHighlight(target)
        end
    end
end

UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if not gameProcessed and input.KeyCode == LOCK_KEY then
        toggle()
    end
end)

-- ===== MAIN LOOP - PURE OVERRIDE =====
RunService.RenderStepped:Connect(function()
    if isLocked then
        -- FORCE DISABLE AUTO-ROTATE EVERY FRAME
        humanoid.AutoRotate = false
        
        -- CHECK TARGET STILL VALID
        if not lockedTarget or not lockedTarget.Parent then
            toggle()
            return
        end
        
        local hum = lockedTarget.Parent:FindFirstChild("Humanoid")
        if not hum or hum.Health <= 0 then
            toggle()
            return
        end
        
        -- LOCK ROTATION - EVERY SINGLE FRAME
        lockRotation()
    end
end)

-- ===== RESPAWN =====
player.CharacterAdded:Connect(function(char)
    character = char
    humanoid = char:WaitForChild("Humanoid")
    hrp = char:WaitForChild("HumanoidRootPart")
    isLocked = false
    lockedTarget = nil
    removeHighlight()
end)

