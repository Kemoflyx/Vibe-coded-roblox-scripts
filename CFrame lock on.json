-- Minimal Character-Only Lock-On (Optimized + Subtle Highlight)

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local hrp = character:WaitForChild("HumanoidRootPart")

-- ===== CONFIG =====
local LOCK_KEY = Enum.KeyCode.E
local PREDICTION = 0.1

local PITCH_SPEED = 0.35
local MAX_PITCH = math.rad(45)

local GROUND_PITCH_MULT = 0.25
local AIR_PITCH_MULT = 1
local AIR_Y_THRESHOLD = 3

local RELOCK_INTERVAL = 0.5
-- ==================

-- ===== STATE =====
local lockedTarget
local targetVelocity = Vector3.zero
local isLocked = false
local originalAutoRotate = humanoid.AutoRotate
local lastRelock = 0

local rootJoint
local originalC0
local currentPitch = 0

local targetHighlight
-- =================

-- ===== JOINT SETUP =====
local function setupJoint()
    if character:FindFirstChild("LowerTorso") then
        rootJoint = character.LowerTorso:FindFirstChild("Root")
    else
        rootJoint = hrp:FindFirstChild("RootJoint")
    end
    if rootJoint then
        originalC0 = rootJoint.C0
    end
end

setupJoint()

local function resetPitch()
    if rootJoint and originalC0 then
        rootJoint.C0 = originalC0
    end
    currentPitch = 0
end
-- ======================

-- ===== HIGHLIGHT =====
local function applyHighlight(target)
    if targetHighlight then targetHighlight:Destroy() end

    local h = Instance.new("Highlight")
    h.Adornee = target.Parent
    h.FillTransparency = 1 -- no fill
    h.OutlineTransparency = 0.35
    h.OutlineColor = Color3.fromRGB(80, 200, 190) -- soft cyan/teal
    h.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    h.Parent = target.Parent

    targetHighlight = h
end

local function removeHighlight()
    if targetHighlight then
        targetHighlight:Destroy()
        targetHighlight = nil
    end
end
-- =====================

-- ===== TARGET FIND =====
local function findClosestTarget()
    local cam = workspace.CurrentCamera
    local mouse = UserInputService:GetMouseLocation()
    local best, bestDist = nil, math.huge

    for _, hum in ipairs(workspace:GetDescendants()) do
        if hum:IsA("Humanoid") and hum.Health > 0 then
            local char = hum.Parent
            if char ~= character then
                local root = char:FindFirstChild("HumanoidRootPart")
                if root then
                    local pos, onScreen = cam:WorldToViewportPoint(root.Position)
                    if onScreen then
                        local d = (Vector2.new(pos.X, pos.Y) - mouse).Magnitude
                        if d < bestDist then
                            bestDist = d
                            best = root
                        end
                    end
                end
            end
        end
    end

    return best
end
-- =======================

local function isRagdolled()
    local s = humanoid:GetState()
    return s == Enum.HumanoidStateType.Ragdoll
        or s == Enum.HumanoidStateType.Physics
        or s == Enum.HumanoidStateType.FallingDown
end

local function validTarget(t)
    local h = t and t.Parent and t.Parent:FindFirstChildOfClass("Humanoid")
    return h and h.Health > 0
end

-- ===== ROTATION =====
local function updateRotation()
    local vel = lockedTarget.AssemblyLinearVelocity or Vector3.zero
    targetVelocity = targetVelocity:Lerp(vel, 0.4)

    local predicted = lockedTarget.Position + targetVelocity * PREDICTION
    local dir = predicted - hrp.Position
    if dir.Magnitude < 0.01 then return end

    -- YAW
    local flat = Vector3.new(dir.X, 0, dir.Z)
    if flat.Magnitude > 0.01 then
        local _, y, _ = CFrame.lookAt(hrp.Position, hrp.Position + flat):ToOrientation()
        hrp.CFrame = CFrame.new(hrp.Position) * CFrame.Angles(0, y, 0)
    end

    -- PITCH
    if rootJoint and originalC0 then
        local rawPitch = math.atan2(dir.Y, flat.Magnitude)
        local air = math.abs(dir.Y) > AIR_Y_THRESHOLD
        local mult = air and AIR_PITCH_MULT or GROUND_PITCH_MULT

        local desired = math.clamp(rawPitch * mult, -MAX_PITCH, MAX_PITCH)
        currentPitch += (desired - currentPitch) * PITCH_SPEED

        rootJoint.C0 = originalC0 * CFrame.Angles(-currentPitch, 0, 0)
    end
end
-- ====================

-- ===== TOGGLE =====
local function toggleLock()
    if isLocked then
        isLocked = false
        lockedTarget = nil
        humanoid.AutoRotate = originalAutoRotate
        resetPitch()
        removeHighlight()
    else
        local t = findClosestTarget()
        if t then
            isLocked = true
            lockedTarget = t
            targetVelocity = t.AssemblyLinearVelocity or Vector3.zero
            humanoid.AutoRotate = false
            lastRelock = tick()
            applyHighlight(t)
        end
    end
end
-- ===================

UserInputService.InputBegan:Connect(function(i, gp)
    if not gp and i.KeyCode == LOCK_KEY then
        toggleLock()
    end
end)

-- ===== MAIN LOOP =====
RunService.RenderStepped:Connect(function()
    if not isLocked then return end

    if isRagdolled() then
        humanoid.AutoRotate = originalAutoRotate
        resetPitch()
        removeHighlight()
        return
    end

    local now = tick()
    if now - lastRelock >= RELOCK_INTERVAL then
        lastRelock = now
        humanoid.AutoRotate = false
    end

    if not validTarget(lockedTarget) then
        toggleLock()
        return
    end

    updateRotation()
end)
-- ====================

-- ===== RESPAWN =====
player.CharacterAdded:Connect(function(c)
    character = c
    humanoid = c:WaitForChild("Humanoid")
    hrp = c:WaitForChild("HumanoidRootPart")
    originalAutoRotate = humanoid.AutoRotate
    setupJoint()
    resetPitch()
    removeHighlight()
    isLocked = false
end)
-- ====================
